<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clima ‚Äî Previs√£o Profissional (Open-Meteo)</title>
<meta name="description" content="Site de clima responsivo usando Open-Meteo (API gratuita, sem chave)."/>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#2bb7ff; --glass: rgba(255,255,255,0.03);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#e6eef8;
}
*{box-sizing:border-box}
html,body,#app{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#051023 0%, #071427 50%, #08192a 100%);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding:20px;
}
.container{
  max-width:1100px; margin:0 auto; display:grid; gap:18px;
  grid-template-columns: 360px 1fr;
}
.header{
  grid-column:1/-1; display:flex; gap:12px; align-items:center; justify-content:space-between;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#6ee7b7);
  display:flex;align-items:center;justify-content:center;font-weight:700;color:#022233;font-size:20px;
  box-shadow:0 6px 24px rgba(43,183,255,0.08);
}
.title{font-size:18px;font-weight:700;line-height:1}
.subtitle{font-size:12px;color:var(--muted);margin-top:2px}
.controls{display:flex;gap:8px;align-items:center}
.search{
  background:var(--glass); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:10px;
  display:flex; gap:8px; align-items:center; width:380px; max-width:48vw;
}
.search input{background:transparent;border:0;color:inherit;outline:none;font-size:14px;width:100%}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 10px;border-radius:10px; cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),#6ee7b7); color:#012; border:0}
.layout{
  gap:18px; display:grid; grid-template-columns: 1fr; align-items:start;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.03); padding:18px; border-radius:14px;
  box-shadow: 0 6px 30px rgba(2,6,23,0.5);
}
.current{
  display:flex; gap:18px; align-items:center;
  flex-wrap:wrap;
}
.icon-wrap{width:120px;height:120px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
.temp{font-size:40px;font-weight:700}
.loc{font-size:14px;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
.kv{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;min-width:120px;text-align:center}
.forecast{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap:10px;margin-top:14px;
}
.day{padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:center}
.hourly-scroll{display:flex;gap:10px;overflow:auto;padding:10px 2px}
.hour{
  min-width:84px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:center;
}
.footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;padding-top:6px}
.search-suggestion{color:var(--muted);font-size:13px;margin-top:6px}
@media (max-width:1000px){
  .container{grid-template-columns: 1fr; padding-bottom:20px}
  .search{width:100%}
  .logo{display:none}
}
</style>
</head>
<body>
<div id="app" class="container" aria-live="polite">
  <div class="header card">
    <div class="brand">
      <div class="logo">CL</div>
      <div>
        <div class="title">Clima Profissional</div>
        <div class="subtitle">Dados: Open-Meteo ‚Ä¢ Geocoding: Nominatim (OpenStreetMap)</div>
      </div>
    </div>

    <div class="controls">
      <div class="search" role="search" aria-label="Pesquisar cidade">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="q" placeholder="Pesquisar cidade, ex: S√£o Paulo ou CEP" />
        <button id="searchBtn" class="btn" title="Pesquisar">Ir</button>
      </div>
      <button id="gpsBtn" class="btn" title="Usar minha localiza√ß√£o">üìç Minha localiza√ß√£o</button>
      <button id="unitsBtn" class="btn" title="Alternar unidades">¬∞C / ¬∞F</button>
    </div>
  </div>

  <main class="layout">
    <section class="card" aria-label="Clima atual">
      <div id="current" class="current">
        <div class="icon-wrap" id="weatherIcon" aria-hidden="true">‚òÄÔ∏è</div>
        <div style="flex:1;min-width:200px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="temp" id="temp">--¬∞C</div>
              <div class="loc" id="place">Carregando localiza√ß√£o...</div>
            </div>
            <div class="small" id="conds">--</div>
          </div>

          <div class="row" id="summaryRow" aria-hidden="false">
            <div class="kv"><div class="small">Vento</div><div id="wind" style="font-weight:600">-- km/h</div></div>
            <div class="kv"><div class="small">Umidade</div><div id="hum" style="font-weight:600">--%</div></div>
            <div class="kv"><div class="small">Precipita√ß√£o</div><div id="prec" style="font-weight:600">-- mm</div></div>
            <div class="kv"><div class="small">Press√£o</div><div id="press" style="font-weight:600">-- hPa</div></div>
          </div>

          <div class="small search-suggestion" id="attribution">Fonte: open-meteo.com ‚Ä¢ sem chave</div>
        </div>
      </div>

      <div style="margin-top:16px">
        <div class="small" style="margin-bottom:8px">Previs√£o di√°ria</div>
        <div id="forecast" class="forecast"></div>
      </div>
    </section>

    <aside class="card" aria-label="Detalhes e hor√°rio">
      <div class="small" style="margin-bottom:8px">Pr√≥ximas 24 horas</div>
      <div id="hourly" class="hourly-scroll" role="list"></div>

      <div style="margin-top:16px">
        <div class="small" style="margin-bottom:8px">Buscar por cidade</div>
        <div class="small">Dica: use cidade, cidade, pa√≠s ou CEP.</div>
      </div>
    </aside>

    <div class="footer">Feito com Open-Meteo ‚Ä¢ N√£o requer chave ‚Ä¢ Offline parcial via cache local</div>
  </main>
</div>

<script>
/* Configura√ß√µes */
const OPEN_METEO_BASE = 'https://api.open-meteo.com/v1/forecast';
const NOMINATIM_SEARCH = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&q=';
const NOMINATIM_REVERSE = 'https://nominatim.openstreetmap.org/reverse?format=json&zoom=10&';
const cacheKey = 'clima_cache_v1';
let useCelsius = true;

/* Mapeamento weathercode -> descri√ß√£o + emoji/icon */
const weatherMap = {
  0: ['C√©u limpo','‚òÄÔ∏è'],
  1: ['Principalmente ensolarado','üå§Ô∏è'],
  2: ['Parcialmente nublado','‚õÖ'],
  3: ['Nublado','‚òÅÔ∏è'],
  45: ['Neblina','üå´Ô∏è'],
  48: ['Deposi√ß√£o de gelo','üå´Ô∏è'],
  51: ['Chuvisco leve','üå¶Ô∏è'],
  53: ['Chuvisco moderado','üåßÔ∏è'],
  55: ['Chuvisco forte','üåßÔ∏è'],
  56: ['Chuvisco congelante leve','üíß‚ùÑÔ∏è'],
  57: ['Chuvisco congelante forte','üíß‚ùÑÔ∏è'],
  61: ['Chuva fraca','üå¶Ô∏è'],
  63: ['Chuva moderada','üåßÔ∏è'],
  65: ['Chuva forte','‚õàÔ∏è'],
  66: ['Chuva congelante fraca','üåßÔ∏è‚ùÑÔ∏è'],
  67: ['Chuva congelante forte','üåßÔ∏è‚ùÑÔ∏è'],
  71: ['Neve fraca','üå®Ô∏è'],
  73: ['Neve moderada','üå®Ô∏è'],
  75: ['Neve forte','‚ùÑÔ∏è'],
  77: ['C√∫mulos de gelo','‚ùÑÔ∏è'],
  80: ['Chuva de curta dura√ß√£o','üåßÔ∏è'],
  81: ['Chuvas frequentes','üåßÔ∏è'],
  82: ['Chuvas fortes frequentes','‚õàÔ∏è'],
  85: ['Aguaceiros de neve','üå®Ô∏è'],
  86: ['Aguaceiros de neve fortes','‚ùÑÔ∏è'],
  95: ['Trovoada','‚õàÔ∏è'],
  96: ['Trovoada com granizo leve','‚õàÔ∏è‚ùÑÔ∏è'],
  99: ['Trovoada com granizo forte','‚õàÔ∏è‚ùÑÔ∏è']
};

/* Utils */
const el = id => document.getElementById(id);
const show = (id, v) => el(id).textContent = v;
const fmtTemp = t => useCelsius ? Math.round(t)+'¬∞C' : Math.round(t * 9/5 + 32)+'¬∞F';
const fmtWind = v => Math.round(v) + (useCelsius? ' km/h' : ' km/h'); // Open-Meteo returns km/h default
const saveCache = (obj) => localStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data:obj}));
const loadCache = () => { try { const s = JSON.parse(localStorage.getItem(cacheKey)); if(!s) return null; if(Date.now()-s.ts>1000*60*30) return null; return s.data; } catch(e){return null} };

/* Renderers */
function renderCurrent(placeName, cw, extra){
  const code = cw.weathercode;
  const [desc, icon] = weatherMap[code] || ['Desconhecido','‚ùî'];
  el('weatherIcon').textContent = icon;
  show('temp', fmtTemp(cw.temperature));
  show('place', placeName);
  show('conds', desc);
  show('wind', (Math.round(cw.windspeed)) + ' km/h');
  show('hum', (extra && extra.humidity !== undefined) ? extra.humidity + '%' : '--%');
  show('prec', (extra && extra.precip !== undefined) ? extra.precip + ' mm' : '0 mm');
  show('press', (extra && extra.pressure !== undefined) ? extra.pressure + ' hPa' : '--');
}

/* Construir forecast di√°rio */
function renderDaily(daily, timezone){
  const container = el('forecast');
  container.innerHTML = '';
  if(!daily || !daily.time) return;
  for(let i=0;i<daily.time.length;i++){
    const day = daily.time[i];
    const max = daily.temperature_2m_max[i];
    const min = daily.temperature_2m_min[i];
    const code = daily.weathercode[i];
    const [desc, icon] = weatherMap[code] || ['--','‚ùî'];
    const elDay = document.createElement('div');
    elDay.className = 'day';
    elDay.innerHTML = `<div style="font-weight:700">${new Date(day).toLocaleDateString(undefined,{weekday:'short',day:'numeric',month:'short'})}</div>
                       <div style="font-size:20px;margin:6px 0">${icon}</div>
                       <div style="font-size:13px;color:var(--muted)">${desc}</div>
                       <div style="margin-top:8px;font-weight:600">${fmtTemp(max)} / ${fmtTemp(min)}</div>`;
    container.appendChild(elDay);
  }
}

/* Construir hourly next 24 */
function renderHourly(hourly){
  const container = el('hourly');
  container.innerHTML = '';
  if(!hourly || !hourly.time) return;
  const now = Date.now();
  for(let i=0;i<hourly.time.length && i<24;i++){
    const t = new Date(hourly.time[i]);
    const temp = hourly.temperature_2m[i];
    const code = hourly.weathercode ? hourly.weathercode[i] : 0;
    const [desc, icon] = weatherMap[code] || ['--','‚ùî'];
    const hourStr = t.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const div = document.createElement('div');
    div.className = 'hour';
    div.innerHTML = `<div style="font-weight:700">${hourStr}</div><div style="font-size:22px">${icon}</div><div style="margin-top:6px">${fmtTemp(temp)}</div><div class="small" style="margin-top:6px;color:var(--muted)">${desc}</div>`;
    container.appendChild(div);
  }
}

/* Busca e renderiza dados a partir de lat/lon */
async function fetchAndRender(lat, lon, placeName){
  el('place').textContent = 'Carregando dados...';
  try{
    const params = new URLSearchParams({
      latitude: lat,
      longitude: lon,
      current_weather: 'true',
      timezone: 'auto',
      hourly: ['temperature_2m','weathercode','relativehumidity_2m','precipitation','windspeed_10m'].join(','),
      daily: ['temperature_2m_max','temperature_2m_min','weathercode','precipitation_sum'].join(',')
    });
    const url = `${OPEN_METEO_BASE}?${params.toString()}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Erro na API Open-Meteo');
    const data = await res.json();
    // Extras: humidity from hourly at current hour if available
    const cw = data.current_weather;
    let humidity = null, precip = null, pressure = null;
    if(data.hourly && data.hourly.time){
      // find nearest hour index
      const nowISO = cw.time;
      const idx = data.hourly.time.indexOf(nowISO);
      if(idx >= 0){
        humidity = Math.round(data.hourly.relativehumidity_2m[idx]);
        precip = (data.hourly.precipitation ? data.hourly.precipitation[idx] : 0);
      }
    }
    renderCurrent(placeName || `${lat.toFixed(3)}, ${lon.toFixed(3)}`, cw, {humidity,precip,pressure});
    renderDaily(data.daily, data.timezone);
    renderHourly(data.hourly);
    saveCache({lat,lon,placeName,data});
  }catch(err){
    console.error(err);
    const cached = loadCache();
    if(cached){
      renderCurrent(cached.placeName || (cached.lat+','+cached.lon), cached.data.current_weather, {});
      renderDaily(cached.data.daily);
      renderHourly(cached.data.hourly);
      el('place').textContent += ' (offline, usando cache)';
    } else {
      el('place').textContent = 'Erro ao carregar dados';
      el('temp').textContent = '--';
    }
  }
}

/* Geocoding Nominatim - retorna array de {lat,lon,display_name} */
async function geocode(q){
  const url = NOMINATIM_SEARCH + encodeURIComponent(q);
  const res = await fetch(url, {headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('Erro Nominatim');
  const arr = await res.json();
  return arr.map(a=>({lat:parseFloat(a.lat), lon:parseFloat(a.lon), display_name: a.display_name}));
}

/* Reverse geocode */
async function reverseGeocode(lat, lon){
  const url = `${NOMINATIM_REVERSE}lat=${lat}&lon=${lon}`;
  try{
    const res = await fetch(url);
    if(!res.ok) return null;
    const j = await res.json();
    return j.display_name || null;
  }catch(e){
    return null;
  }
}

/* Eventos UI */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  el('place').textContent = 'Buscando...';
  try{
    const results = await geocode(q);
    if(results.length===0){ el('place').textContent = 'Nenhum resultado'; return; }
    const first = results[0];
    await fetchAndRender(first.lat, first.lon, first.display_name);
  }catch(e){
    el('place').textContent = 'Erro ao pesquisar';
    console.error(e);
  }
});

document.getElementById('gpsBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ el('place').textContent = 'Geolocaliza√ß√£o n√£o suportada'; return;}
  el('place').textContent = 'Pegando localiza√ß√£o...';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const name = await reverseGeocode(lat,lon) || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    await fetchAndRender(lat, lon, name);
  }, err=>{
    el('place').textContent = 'Permiss√£o de localiza√ß√£o negada ou erro';
  }, {enableHighAccuracy:true, timeout:10000});
});

document.getElementById('unitsBtn').addEventListener('click', ()=>{
  useCelsius = !useCelsius;
  // re-render from cache or current display
  const cached = loadCache();
  if(cached) {
    renderCurrent(cached.placeName || (cached.lat+','+cached.lon), cached.data.current_weather, {});
    renderDaily(cached.data.daily);
    renderHourly(cached.data.hourly);
  } else {
    // will simply change current value shown
    const t = parseFloat(el('temp').textContent) || null;
  }
});

/* Inicializa√ß√£o: tenta usar cache, ent√£o geolocaliza√ß√£o, ent√£o fallback para SP */
(async function init(){
  const cached = loadCache();
  if(cached){
    await fetchAndRender(cached.lat, cached.lon, cached.placeName);
    return;
  }
  // try geolocation silently
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const name = await reverseGeocode(lat,lon) || `${lat.toFixed(3)},${lon.toFixed(3)}`;
      await fetchAndRender(lat, lon, name);
    }, async ()=>{
      // fallback to S√£o Paulo
      await fetchAndRender(-23.550520, -46.633308, 'S√£o Paulo, Brasil (padr√£o)');
    }, {timeout:7000});
  } else {
    await fetchAndRender(-23.550520, -46.633308, 'S√£o Paulo, Brasil (padr√£o)');
  }
})();
</script>
</body>
</html>

